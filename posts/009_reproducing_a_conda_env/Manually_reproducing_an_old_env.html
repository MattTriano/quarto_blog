<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matt Triano">
<meta name="dcterms.date" content="2023-07-13">
<meta name="description" content="How to reverse engineer an old env and rerun old work">

<title>Matt Triano - How to Manually Reproduce a Conda Env</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: [{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: [],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-listing'] = new List('listing-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<link rel="alternate" type="application/rss+xml" title="Matt Triano" href="Manually_reproducing_an_old_env.xml"></head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Matt Triano</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/MattTriano" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">How to Manually Reproduce a Conda Env</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
                  <div>
        <div class="description">
          How to reverse engineer an old env and rerun old work
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">conda</div>
                <div class="quarto-category">tutorial</div>
                <div class="quarto-category">howto</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Matt Triano </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 13, 2023</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">July 13, 2023</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#steps" id="toc-steps" class="nav-link" data-scroll-target="#steps"><span class="header-section-number">2</span> Steps</a>
  <ul class="collapse">
  <li><a href="#step-0.-configure-conda" id="toc-step-0.-configure-conda" class="nav-link" data-scroll-target="#step-0.-configure-conda"><span class="header-section-number">2.1</span> Step 0. Configure conda</a></li>
  <li><a href="#step-1.-determine-packages-used-in-the-old-work" id="toc-step-1.-determine-packages-used-in-the-old-work" class="nav-link" data-scroll-target="#step-1.-determine-packages-used-in-the-old-work"><span class="header-section-number">2.2</span> Step 1. Determine packages used in the old work</a>
  <ul class="collapse">
  <li><a href="#determining-when-the-analysis-was-run" id="toc-determining-when-the-analysis-was-run" class="nav-link" data-scroll-target="#determining-when-the-analysis-was-run"><span class="header-section-number">2.2.1</span> Determining when the analysis was run</a></li>
  <li><a href="#determining-used-packages" id="toc-determining-used-packages" class="nav-link" data-scroll-target="#determining-used-packages"><span class="header-section-number">2.2.2</span> Determining used packages</a></li>
  </ul></li>
  <li><a href="#step-2.-determine-max-versions-at-analysis-time" id="toc-step-2.-determine-max-versions-at-analysis-time" class="nav-link" data-scroll-target="#step-2.-determine-max-versions-at-analysis-time"><span class="header-section-number">2.3</span> Step 2. Determine max versions at analysis-time</a></li>
  <li><a href="#step-3.-create-the-env-and-register-it-as-a-notebook-kernel" id="toc-step-3.-create-the-env-and-register-it-as-a-notebook-kernel" class="nav-link" data-scroll-target="#step-3.-create-the-env-and-register-it-as-a-notebook-kernel"><span class="header-section-number">2.4</span> Step 3. Create the env and register it as a notebook kernel</a></li>
  <li><a href="#step-4.-attempt-to-reproduce-prior-results-and-troubleshoot-issues" id="toc-step-4.-attempt-to-reproduce-prior-results-and-troubleshoot-issues" class="nav-link" data-scroll-target="#step-4.-attempt-to-reproduce-prior-results-and-troubleshoot-issues"><span class="header-section-number">2.5</span> Step 4. Attempt to reproduce prior results and troubleshoot issues</a>
  <ul class="collapse">
  <li><a href="#troubleshooting-1" id="toc-troubleshooting-1" class="nav-link" data-scroll-target="#troubleshooting-1"><span class="header-section-number">2.5.1</span> Troubleshooting 1</a></li>
  <li><a href="#troubleshooting-2" id="toc-troubleshooting-2" class="nav-link" data-scroll-target="#troubleshooting-2"><span class="header-section-number">2.5.2</span> Troubleshooting 2</a></li>
  </ul></li>
  <li><a href="#step-5.-export-the-env" id="toc-step-5.-export-the-env" class="nav-link" data-scroll-target="#step-5.-export-the-env"><span class="header-section-number">2.6</span> Step 5. Export the env</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">3</span> Summary</a></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix"><span class="header-section-number">4</span> Appendix</a>
  <ul class="collapse">
  <li><a href="#side-projects" id="toc-side-projects" class="nav-link" data-scroll-target="#side-projects"><span class="header-section-number">4.1</span> Side Projects</a>
  <ul class="collapse">
  <li><a href="#sec-side-project-1" id="toc-sec-side-project-1" class="nav-link" data-scroll-target="#sec-side-project-1"><span class="header-section-number">4.1.1</span> git diff side project</a></li>
  </ul></li>
  <li><a href="#footnotes" id="toc-footnotes" class="nav-link" data-scroll-target="#footnotes"><span class="header-section-number">4.2</span> Footnotes</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="overview" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview</h1>
<p>This post will demonstrate how to reproduce an old conda env (that wasn’t exported to an <code>environment.yml</code> file at the time of analysis/usage) needed to rerun old analysis<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
</section>
<section id="steps" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Steps</h1>
<section id="step-0.-configure-conda" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="step-0.-configure-conda"><span class="header-section-number">2.1</span> Step 0. Configure conda</h2>
<p>Install conda and configure it as shown in steps 3 &amp; 4 <a href="../../posts/000_setting_up_miniconda/Setting_up_Miniconda.html">here</a>.</p>
</section>
<section id="step-1.-determine-packages-used-in-the-old-work" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="step-1.-determine-packages-used-in-the-old-work"><span class="header-section-number">2.2</span> Step 1. Determine packages used in the old work</h2>
<p>Look at the old analysis and any available metadata to determine:</p>
<ol type="1">
<li>When was the analysis run?</li>
<li>What packages were used?</li>
</ol>
<p>For this demonstration, I’m reproducing an env I used to analyze crime and prison data back in 2018. Specifically, I want to produce an env that enables me to rerun these notebooks:</p>
<ul>
<li><a href="https://github.com/MattTriano/personal_site_public/blob/master/Crime_and_Prisons_part1.ipynb">Crime and Prisons part 1</a></li>
<li><a href="https://github.com/MattTriano/personal_site_public/blob/master/Crime_and_Prisons_part2.ipynb">Crime and Prisons part 2</a></li>
<li><a href="https://github.com/MattTriano/personal_site_public/blob/master/Crime_and_Prisons_part3.ipynb">Crime and Prisons part 3</a></li>
</ul>
<section id="determining-when-the-analysis-was-run" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="determining-when-the-analysis-was-run"><span class="header-section-number">2.2.1</span> Determining when the analysis was run</h3>
<p>Looking at the latest commits for these notebooks, we can set an upper bound on versions used. The latest commits for these notebooks are:</p>
<ul>
<li>Part 1: June 26, 2018</li>
<li>Part 2: Aug 16, 2018</li>
<li>Part 3: June 15, 2018</li>
</ul>
<p>From the sidequest described in <a href="#sec-side-project-1">Section&nbsp;4.1.1</a>, I’ve decided on using June 15, 2018 as the upper-bound date for analysis.</p>
</section>
<section id="determining-used-packages" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="determining-used-packages"><span class="header-section-number">2.2.2</span> Determining used packages</h3>
<p>For this, I simply look at the <code>import</code> statements, which are compiled below.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> ticker</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.core.display <span class="im">import</span> display, HTML</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bokeh.sampledata.us_states <span class="im">import</span> data <span class="im">as</span> states</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bokeh.plotting <span class="im">import</span> figure, show, output_notebook</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bokeh.models <span class="im">import</span> HoverTool, ColumnDataSource</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bokeh.models <span class="im">import</span> LinearColorMapper, ColorBar, BasicTicker</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This boils down to [<code>pandas</code>, <code>numpy</code>, <code>seaborn</code>, <code>matplotlib</code>, <code>IPython</code>, and <code>bokeh</code>] (there’s also <code>os</code>, but that’s a python built-in).</p>
</section>
</section>
<section id="step-2.-determine-max-versions-at-analysis-time" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="step-2.-determine-max-versions-at-analysis-time"><span class="header-section-number">2.3</span> Step 2. Determine max versions at analysis-time</h2>
<p>First, I want to determine the version of python to use. Looking at the <a href="https://en.wikipedia.org/wiki/History_of_Python#Table_of_versions">release dates</a> of python versions, we see that python v3.6 was released on 2016-12-23 and python v3.7 was released on 2018-06-27, so the it’s most likely that python v3.6 was used.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Corroboration">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Corroboration
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Looking at the <a href="https://raw.githubusercontent.com/MattTriano/personal_site_public/master/Crime_and_Prisons_part2.ipynb">raw file</a>, specifically a few lines from the very bottom of the document, the <code>metadata</code> block indicates the kernel used python v3.6.4</p>
</div>
</div>
</div>
<p>Next, I want to determine max versions for <code>pandas</code>, <code>numpy</code>, <code>seaborn</code>, <code>matplotlib</code>, <code>IPython</code>, and <code>bokeh</code>. I know <code>pandas</code> uses <code>numpy</code> and <code>seaborn</code> uses <code>matplotlib</code>, so I can ignore <code>numpy</code> and <code>matplotlib</code>.</p>
<p>I’ll look at each package’s <strong>releases</strong> page to see the last version before the cutoff date.</p>
<ul>
<li><a href="https://github.com/pandas-dev/pandas/releases"><code>pandas</code></a>: <a href="https://github.com/pandas-dev/pandas/releases/tag/v0.24.2">v0.24.2</a></li>
<li><a href="https://github.com/mwaskom/seaborn/releases"><code>seaborn</code></a>: <a href="https://github.com/mwaskom/seaborn/releases/tag/v0.8.1">v0.8.1</a></li>
<li><a href="https://github.com/bokeh/bokeh/tags"><code>bokeh</code></a>: <a href="https://github.com/bokeh/bokeh/releases/tag/0.12.16">v0.12.16</a></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Corroboration">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Corroboration
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Looking at the <a href="https://raw.githubusercontent.com/MattTriano/personal_site_public/master/Crime_and_Prisons_part2.ipynb">raw file</a>, specifically by ctrl+f searching “version”, we see that bokeh v0.12.16 was used.</p>
</div>
</div>
</div>
<p>Also, <code>IPython</code> was included as it’s a dependency of the (jupyter) <code>notebook</code> package (which I used to develop the notebooks). There will probably be several other infrastructural</p>
<ul>
<li><a href="https://github.com/jupyter/notebook/releases">jupyter <code>notebook</code></a>: <a href="https://github.com/jupyter/notebook/releases/tag/5.5.0">v5.5.0</a></li>
</ul>
</section>
<section id="step-3.-create-the-env-and-register-it-as-a-notebook-kernel" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="step-3.-create-the-env-and-register-it-as-a-notebook-kernel"><span class="header-section-number">2.4</span> Step 3. Create the env and register it as a notebook kernel</h2>
<p>From the prior step, we determined the following version constraints.</p>
<ul>
<li><code>python=3.6.4</code></li>
<li><code>pandas&lt;=0.24.2</code></li>
<li><code>seaborn&lt;=0.8.1</code></li>
<li><code>bokeh==0.12.16</code></li>
<li><code>notebook&lt;=5.5.0</code></li>
</ul>
<p>I’ll run the command below to create a conda env named <strong>prisons_post_env</strong> that meets those constraints.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">--name</span> prisons_post_env <span class="st">"python=3.6.4"</span> <span class="st">"pandas&lt;=0.24.2"</span> <span class="st">"seaborn&lt;=0.8.1"</span> <span class="st">"bokeh=0.12.16"</span> <span class="st">"notebook&lt;=5.5.0"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Activate that conda env</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate prisons_post_env</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and register that conda env as a <a href="https://stackoverflow.com/questions/39604271/conda-environments-not-showing-up-in-jupyter-notebook">notebook kernel</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">prisons_post_env</span><span class="kw">)</span> <span class="ex">...$</span> python <span class="at">-m</span> ipykernel install <span class="at">--user</span> <span class="at">--name</span> prisons_post_env <span class="at">--display-name</span> <span class="st">"(prisons_post_env)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-4.-attempt-to-reproduce-prior-results-and-troubleshoot-issues" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="step-4.-attempt-to-reproduce-prior-results-and-troubleshoot-issues"><span class="header-section-number">2.5</span> Step 4. Attempt to reproduce prior results and troubleshoot issues</h2>
<p>Now you can start up a notebook server (I’ve specified a port number as I’m already running a jupyterlab server on the default port, <code>8888</code>)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">jupyter</span> notebook <span class="at">--port</span><span class="op">=</span>9494</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="troubleshooting-1" class="level3" data-number="2.5.1">
<h3 data-number="2.5.1" class="anchored" data-anchor-id="troubleshooting-1"><span class="header-section-number">2.5.1</span> Troubleshooting 1</h3>
<p>While trying to open up the part 2 notebook, the connection attempt hung and the terminal showed an error.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">~/</span>miniconda3<span class="op">/</span>envs<span class="op">/</span>prisons_post_env<span class="op">/</span>lib<span class="op">/</span>python3<span class="fl">.6</span><span class="op">/</span>site<span class="op">-</span>packages<span class="op">/</span>notebook<span class="op">/</span>base<span class="op">/</span>zmqhandlers.py:<span class="dv">284</span>:  <span class="pp">RuntimeWarning</span>: coroutine <span class="st">'WebSocketHandler.get'</span> was never awaited</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Googling the error took me to a <a href="https://stackoverflow.com/questions/54963043/jupyter-notebook-no-connection-to-server-because-websocket-connection-fails">Stack Overflow question</a> that indicates package <code>tornado</code> v6+ caused the issue, so let’s downgrade <code>tornado</code> in our env</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">prisons_post_env</span><span class="kw">)</span> <span class="ex">...$</span> conda install <span class="at">-c</span> conda-forge <span class="st">"tornado&lt;6"</span> <span class="at">--freeze-installed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>then restart our notebook server (press ctrl+c in the terminal, shut it down, then start it back up with the earlier <code>jupyter notebook</code> command). When you reopen the <code>Crime_and_Prisons_part2.ipynb</code> notebook, you should find that it successfully connects to the kernel and you can run through cells. At least up until cell that calls the <code>plot_male_v_female_by_state_sea()</code> function.</p>
</section>
<section id="troubleshooting-2" class="level3" data-number="2.5.2">
<h3 data-number="2.5.2" class="anchored" data-anchor-id="troubleshooting-2"><span class="header-section-number">2.5.2</span> Troubleshooting 2</h3>
<p>Upon attempting to run that cell, you will see another error message.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">~/</span>miniconda3<span class="op">/</span>envs<span class="op">/</span>prisons_post_env<span class="op">/</span>lib<span class="op">/</span>python3<span class="fl">.6</span><span class="op">/</span>site<span class="op">-</span>packages<span class="op">/</span>matplotlib<span class="op">/</span>artist.py <span class="kw">in</span> update(<span class="va">self</span>, props)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>: <span class="st">'Rectangle'</span> <span class="bu">object</span> has no <span class="bu">property</span> <span class="st">'normed'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After a few minutes of googling the error message along with the word <strong>matplotlib</strong>, I’ve determined that the problem is that the installed <strong>seaborn</strong> version’s <code>distplot()</code> function calls matplotlib’s <code>hist()</code> plotter function using a keyword argument, <code>normed</code>, that was <a href="https://matplotlib.org/3.2.0/api/api_changes.html#removals">changed</a> in the matplotlib v3.2.0 release. And by running this</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>matplotlib.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I see this env has matplotlib v3.3.2 installed. So let’s downgrade matplotlib.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">prisons_post_env</span><span class="kw">)</span> <span class="ex">...$</span> conda install <span class="at">-c</span> conda-forge <span class="st">"matplotlib&lt;3.2"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Looking at the installation plan, I see that conda wants to upgrade a lot of packages in violation of the earlier constraints. I also tried adding the <code>--freeze-installed</code> option, but conda still wanted to make updates including these.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">bokeh</span>                                      0.12.16-py36_0 <span class="at">--</span><span class="op">&gt;</span> 2.3.3-py36h5fab9bb_0</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">notebook</span>                                     5.5.0-py36_0 <span class="at">--</span><span class="op">&gt;</span> 6.3.0-py36h5fab9bb_0</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">pandas</span>                              0.24.2-py36hb3f55d8_1 <span class="at">--</span><span class="op">&gt;</span> 1.1.5-py36h284efc9_0</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">python</span>                                            3.6.4-0 <span class="at">--</span><span class="op">&gt;</span> 3.6.15-hb7a2778_0_cpython</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">seaborn</span>                                        0.8.1-py_1 <span class="at">--</span><span class="op">&gt;</span> 0.11.2-hd8ed1ab_0</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">tornado</span>                           5.1.1-py36h14c3975_1000 <span class="at">--</span><span class="op">&gt;</span> 6.1-py36h8f6f2f9_1</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So let’s just completely remove and remake the env with all of our constraints, old and new.</p>
<p>After shutting down the jupyter notebook server and ensuring the env is not activated in any open terminal, remove the env directory</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-r</span> ~/miniconda3/envs/prisons_post_env/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>then recreate the env with our additional constraints. Through a fair bit of trial and error, I determined that one of my preferred configs (namely prioritizing the conda-forge channel) was making it impossible to reconcile these constraints, so I overrode the configured channels in favor of the default channel that I was probably using 5 years ago. I’ll also add on the <code>xlrd</code> package, as the part3 notebook loads a <code>.xls</code> file.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">--name</span> prisons_post_env <span class="at">--override-channels</span> <span class="at">--channel</span> defaults <span class="st">"python=3.6.4"</span> <span class="st">"pandas&lt;=0.24.2"</span> <span class="st">"seaborn&lt;=0.8.1"</span> <span class="st">"bokeh=0.12.16"</span> <span class="st">"notebook&lt;=5.5.0"</span> <span class="st">"tornado&lt;6"</span> <span class="st">"matplotlib=2.2.2"</span> xlrd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then activate and re-register the env</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate prisons_post_env</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">prisons_post_env</span><span class="kw">)</span> <span class="ex">...$</span> python <span class="at">-m</span> ipykernel install <span class="at">--user</span> <span class="at">--name</span> prisons_post_env <span class="at">--display-name</span> <span class="st">"(prisons_post_env)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and restart the notebook server.</p>
<p>Now all three of those old notebooks can be run successfully (after collecting and locating the data in the right places).</p>
<div class="callout callout-style-default callout-caution callout-titled" title="Why did changing the conda channel make the dependencies solvable?">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why did changing the conda channel make the dependencies solvable?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You may wonder “How could changing the package source (aka ‘channel’) make the env solvable? The package versions were the same!”</p>
<p>That’s a good observation and intuition! If converting a python package into a conda package was impossible to mess up, there wouldn’t be any difference in conda packages for a given python package version across channels. But conda isn’t just a tool for packaging python code; it’s a tool for <a href="https://conda.io/projects/conda/en/latest/user-guide/concepts/packages.html#what-is-a-conda-package">packaging and distributing any executable</a>, and that often means instructions for building the package and for resolving dependencies are needed. In essence, you need a recipe for making the package. In conda terms, that recipe is a package’s <a href="https://docs.conda.io/projects/conda-build/en/latest/user-guide/tutorials/build-pkgs.html#editing-the-meta-yaml-file">meta.yaml</a> file, and the file provides places to point to build scripts and <a href="https://docs.conda.io/projects/conda-build/en/latest/user-guide/tutorials/building-conda-packages.html#edit-the-skeleton-files">define dependencies</a>. Each conda channel is maintained separately, so each can have different meta.yaml file for a given python package version. Consequently, if dependencies are inconsistent across channels, an env that’s consistent when pulling exclusively from one channel may be unresolvable when pulling exclusively from another channel.</p>
</div>
</div>
</div>
</section>
</section>
<section id="step-5.-export-the-env" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="step-5.-export-the-env"><span class="header-section-number">2.6</span> Step 5. Export the env</h2>
<p>Now that we have a working env, let’s export both the full specification and a cross-platform specification (which only includes the explicitly requested packages).</p>
<div class="cell" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>conda env export <span class="op">-</span>n prisons_post_env <span class="op">&gt;</span> environment.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>conda env export <span class="op">-</span>n prisons_post_env <span class="op">--</span><span class="im">from</span><span class="op">-</span>history <span class="op">&gt;</span> environment_cross_platform.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="summary" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Summary</h1>
<p>This post showed how to reverse engineer the conda env that was used to run old notebooks.</p>
<p>This post also showed a concrete example of a valid conda env seeming inconsistent due to conda weirdness, as well as a troubleshooting strategy (albeit not a very generalizable one) for resolving the problem.</p>
</section>
<section id="appendix" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Appendix</h1>
<section id="side-projects" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="side-projects"><span class="header-section-number">4.1</span> Side Projects</h2>
<p>While working through technical projects, little problems tangential to the main task often pop out and block progress. Often these side quests can be ignored, but</p>
<section id="sec-side-project-1" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="sec-side-project-1"><span class="header-section-number">4.1.1</span> git diff side project</h3>
<p>I don’t recall why I updated Parts 1 and 2 after Part 3. I doubt I made substantive changes, but as I’m using metadata of git commits to determine changes, it only makes sense to look at the diffs. Unfortunately, while github indicates a relatively small number of lines were modified, the diffs are too large to display in browser and I have to review in a locally to see the diffs.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>This is a well-known drawback of jupyter notebooks; plots get represented by very long plaintext strings and rerunning a notebook often changes every line in version control, so diffs can be hard to review).</p>
</div>
</div>
</div>
<p>So I cloned the repo, copied down the hash of the commit I’m interested in (commit 0857e6c), and looked at the diffs of that file in that commit via</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> diff 0857e6c^..0857e6c <span class="at">--</span> Crime_and_Prisons_part2.ipynb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Most of the changes only changed the cell execution-order number or <code>uuid</code>-looking tags. There may also have been changes to the extremely long string representations used to render plots, but they were too long to crosscheck. In fact, those long strings took so long to page through that I stopped reviewing that way and just compared the rendered notebooks (<a href="https://github.com/MattTriano/personal_site_public/blob/04f1224f085a38f32ff58c8719dd31b7a09c3fbc/Crime_and_Prisons_part2.ipynb">pre-commit</a> vs <a href="https://github.com/MattTriano/personal_site_public/blob/master/Crime_and_Prisons_part2.ipynb">commit</a>) and concluded there weren’t any substantive changes, so the timestamp from the earlier commit is adequate.</p>
</section>
</section>
<section id="footnotes" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="footnotes"><span class="header-section-number">4.2</span> Footnotes</h2>



</section>
</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Context: Over the years, I’ve writen up a number of posts for a number of different personal blogs, and I want to consolidate those posts into one platform. Many of my posts involved leveraging the capabilities of jupyter notebooks, and while I’ve always used conda envs to avoid polluting my base python environment, I didn’t reliably export my envs or keep separate envs for each project or purpose. So I occassionally run into a situation where I want to rerun old code on a new machine, but I have to go through extra steps to recreate the env.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>